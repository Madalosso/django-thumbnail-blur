<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Django-thumbnail-blur by Madalosso</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Django-thumbnail-blur</h1>
      <h2 class="project-tagline">Create thumbnails from ImageField plus a blurred [9,9] px image.</h2>
      <a href="https://github.com/Madalosso/django-thumbnail-blur" class="btn">View on GitHub</a>
      <a href="https://github.com/Madalosso/django-thumbnail-blur/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/Madalosso/django-thumbnail-blur/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="django-image-preview-with-dominant-or-blurred-images" class="anchor" href="#django-image-preview-with-dominant-or-blurred-images" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Django Image Preview with Dominant or Blurred images.</h1>

<h3>
<a id="the-problem" class="anchor" href="#the-problem" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The problem.</h3>

<p>Image load is a major topic when the subject is fast load and presentation of a website or web application. I've recently learned and coded a solution that I think you guys could use in your own projects.</p>

<p>First of all, I expect anyone in here to know the concept of thumbnails, if you don't, make a quick search then get back :)</p>

<h3>
<a id="the-context" class="anchor" href="#the-context" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The context</h3>

<p>I've created this solution on a Django App that works as an API to provide information to another app. In this application, the admin had to be able to upload Images to fill a ImageField of one of my models.</p>

<p>As the admins who provide those images to the app aren't trained to treat the images for web, i need my app to do it for them.</p>

<h3>
<a id="the-solution" class="anchor" href="#the-solution" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The solution</h3>

<p>First thing to do: Create thumbnails
There are a lot of good packages to create thumbnails that you can find in <a href="https://www.djangopackages.com/search/?q=thumbnails">djangopackages.com</a>.</p>

<p>I chose to create my own solution using the "<a href="http://pillow.readthedocs.io/en/3.2.x/">PIllow</a>"- a fork of Python Imaging Library that provides lots of resources. Pillow has a module called "Image" with a thumbnail function, this function will re-size your image with the size that you provide as an argument and will remove <a href="https://en.wikipedia.org/wiki/Exchangeable_image_file_format">ExIf</a> as well, creating a lighter version of your original file.</p>

<h3>
<a id="show-me-the-code" class="anchor" href="#show-me-the-code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Show me the code</h3>

<p>Here is where everything happens. While my model.py defines a class with 3 ImageFields, only one field is shown on my django admin, this way, the admin will provide only one picture, and the form will override the standard save method, using him to create other versions of the original picture.
forms.py:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> django <span class="pl-k">import</span> forms
<span class="pl-k">from</span> models <span class="pl-k">import</span> Picture
<span class="pl-k">from</span> <span class="pl-c1">PIL</span> <span class="pl-k">import</span> Image
<span class="pl-k">import</span> base64
<span class="pl-k">import</span> StringIO
<span class="pl-k">from</span> django.core.files.uploadedfile <span class="pl-k">import</span> InMemoryUploadedFile

<span class="pl-k">def</span> <span class="pl-en">generate_resized_image</span>(<span class="pl-smi">source</span>, <span class="pl-smi">size</span>):
    img_l <span class="pl-k">=</span> Image.open(source)
    img_l.thumbnail(size, Image.<span class="pl-c1">ANTIALIAS</span>)
    data_img <span class="pl-k">=</span> StringIO.StringIO()
    img_l.save(data_img, <span class="pl-s"><span class="pl-pds">'</span>JPEG<span class="pl-pds">'</span></span>)
    img_l.close()
    img_temp_file <span class="pl-k">=</span> InMemoryUploadedFile(data_img, <span class="pl-c1">None</span>,
                                         <span class="pl-c1">str</span>(size[<span class="pl-c1">0</span>]) <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>.jpg<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>image/jpeg<span class="pl-pds">'</span></span>,
                                         data_img.len, <span class="pl-c1">None</span>)
    <span class="pl-k">return</span> img_temp_file

<span class="pl-k">class</span> <span class="pl-en">PictureForm</span>(<span class="pl-e">forms</span>.<span class="pl-e">ModelForm</span>):
    <span class="pl-k">class</span> <span class="pl-en">Meta</span>:
        model <span class="pl-k">=</span> Picture
        fields <span class="pl-k">=</span> [<span class="pl-s"><span class="pl-pds">'</span>title<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>description<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>img_l<span class="pl-pds">'</span></span>]

    <span class="pl-k">def</span> <span class="pl-en">save</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">commit</span><span class="pl-k">=</span><span class="pl-c1">True</span>):
        instance <span class="pl-k">=</span> <span class="pl-c1">super</span>(PictureForm, <span class="pl-v">self</span>).save(<span class="pl-v">commit</span><span class="pl-k">=</span><span class="pl-c1">False</span>)
        source <span class="pl-k">=</span> instance.img_l
        size_img_l <span class="pl-k">=</span> <span class="pl-c1">1920</span>, <span class="pl-c1">1080</span>
        size_img_m <span class="pl-k">=</span> <span class="pl-c1">1366</span>, <span class="pl-c1">768</span>
        size_img_s <span class="pl-k">=</span> <span class="pl-c1">768</span>, <span class="pl-c1">432</span>
        size_img_blur <span class="pl-k">=</span> <span class="pl-c1">9</span>, <span class="pl-c1">9</span>
        instance.save()
        img1 <span class="pl-k">=</span> generate_resized_image(source, size_img_l)
        instance.img_l <span class="pl-k">=</span> img1
        instance.img_m <span class="pl-k">=</span> generate_resized_image(source, size_img_m)
        instance.img_s <span class="pl-k">=</span> generate_resized_image(source, size_img_s)
        instance.save()
        <span class="pl-k">return</span> instance</pre></div>

<p>admin.py:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> django.contrib <span class="pl-k">import</span> admin
<span class="pl-k">from</span> models <span class="pl-k">import</span> Picture
<span class="pl-k">from</span> forms <span class="pl-k">import</span> PictureForm


<span class="pl-k">class</span> <span class="pl-en">PictureAdmin</span>(<span class="pl-e">admin</span>.<span class="pl-e">ModelAdmin</span>):
    model <span class="pl-k">=</span> Picture
    form <span class="pl-k">=</span> PictureForm
    verbose_name <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>Picture<span class="pl-pds">"</span></span>
    verbose_name_plural <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>Pictures<span class="pl-pds">"</span></span>
    list_display <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>title<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>description<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>img_s<span class="pl-pds">'</span></span>,
                    <span class="pl-s"><span class="pl-pds">'</span>img_m<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>img_l<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>img_blur<span class="pl-pds">'</span></span>)


admin.site.register(Picture, PictureAdmin)</pre></div>

<p>models.py</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> __future__ <span class="pl-k">import</span> unicode_literals
<span class="pl-k">from</span> django.db <span class="pl-k">import</span> models


<span class="pl-k">def</span> <span class="pl-en">rename_picture</span>(<span class="pl-smi">instance</span>, <span class="pl-smi">filename</span>):
    <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">'</span><span class="pl-c1">{0}</span>_<span class="pl-c1">{1}</span><span class="pl-pds">'</span></span>.format(instance.id, filename)


<span class="pl-k">class</span> <span class="pl-en">Picture</span>(<span class="pl-e">models</span>.<span class="pl-e">Model</span>):
    title <span class="pl-k">=</span> models.CharField(<span class="pl-v">max_length</span><span class="pl-k">=</span><span class="pl-c1">255</span>, <span class="pl-v">null</span><span class="pl-k">=</span><span class="pl-c1">True</span>, <span class="pl-v">blank</span><span class="pl-k">=</span><span class="pl-c1">True</span>)
    description <span class="pl-k">=</span> models.CharField(<span class="pl-v">max_length</span><span class="pl-k">=</span><span class="pl-c1">3000</span>, <span class="pl-v">null</span><span class="pl-k">=</span><span class="pl-c1">True</span>, <span class="pl-v">blank</span><span class="pl-k">=</span><span class="pl-c1">True</span>)
    img_l <span class="pl-k">=</span> models.ImageField(<span class="pl-v">upload_to</span><span class="pl-k">=</span>rename_picture, <span class="pl-v">null</span><span class="pl-k">=</span><span class="pl-c1">False</span>)
    img_m <span class="pl-k">=</span> models.ImageField(<span class="pl-v">upload_to</span><span class="pl-k">=</span>rename_picture)
    img_s <span class="pl-k">=</span> models.ImageField(<span class="pl-v">upload_to</span><span class="pl-k">=</span>rename_picture)
    img_blur <span class="pl-k">=</span> models.CharField(<span class="pl-v">max_length</span><span class="pl-k">=</span><span class="pl-c1">3000</span>)

    <span class="pl-k">def</span> <span class="pl-c1">__unicode__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        <span class="pl-k">return</span> <span class="pl-c1">str</span>(<span class="pl-v">self</span>.nome)</pre></div>

<p>----pictures----</p>

<p>Now, in this example I’m using the '<a href="http://django-storages.readthedocs.io/en/latest/">storages</a>' package to upload these files to my Amazon S3 bucket, but it works on local storage too.</p>

<h3>
<a id="go-further" class="anchor" href="#go-further" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>GO FURTHER!</h3>

<p>OK, now that we have thumbnails, it's time to go a little further to speed up the application load time. Users are impatient, they demand to see something ASAP when they try to load your app, so lets show them something.</p>

<p>Lets create a preview that will be displayed only in the interval between data load from our API and the complete load of our original or thumbnails images from my Amazon S3 bucket.
There are 2 ways to do it.</p>

<ul>
<li>Find the dominant color of a image and display it on the original image size. (Used by Google and Pinterest). I won't be showing how to implement this method, but you can look for functions that already find the right color for each image and store it with your data like the blurred image.</li>
<li>Create a really tiny thumbnail to be stored as a string on our database and display it. It will be blurred and fill the original image size. This way the content will be larger than choosing the dominant approach, but the result is far better.</li>
</ul>

<p>In both cases, as the data will be really small, we can convert the data to a base64 encoded string and save it on the database and return the preview image data along with the rest of the data from the requested object. So the users browser won’t need to wait for the response from Amazon (or your local storage) to see the app. Of course, the preview image should be replaced immediately after the load of the original/thumbnail image. But you already get some seconds displaying something to hold your users attention.</p>

<h3>
<a id="shitty-resolution-image-preview--aka-blurred-image" class="anchor" href="#shitty-resolution-image-preview--aka-blurred-image" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Shitty resolution image preview  (A.k.a. blurred image)</h3>

<p>In this approach I set a [9, 9] pixels size to create a extra thumbnail and encoded the data to be storage on the DB. Check the code and some results bellow:</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> django <span class="pl-k">import</span> forms
<span class="pl-k">from</span> models <span class="pl-k">import</span> Picture
<span class="pl-k">from</span> <span class="pl-c1">PIL</span> <span class="pl-k">import</span> Image
<span class="pl-k">import</span> base64
<span class="pl-k">import</span> StringIO
<span class="pl-k">from</span> django.core.files.uploadedfile <span class="pl-k">import</span> InMemoryUploadedFile


<span class="pl-k">def</span> <span class="pl-en">image_to_b64</span>(<span class="pl-smi">source</span>, <span class="pl-smi">size_img_blur</span>):
    data_img <span class="pl-k">=</span> StringIO.StringIO()
    tiny_img <span class="pl-k">=</span> Image.open(source)
    tiny_img.thumbnail(size_img_blur)
    tiny_img.save(data_img, <span class="pl-v">format</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>BMP<span class="pl-pds">"</span></span>)
    tiny_img.close()
    encoded_b64_picture <span class="pl-k">=</span> base64.b64encode(data_img.getvalue())
    <span class="pl-k">return</span> encoded_b64_picture


<span class="pl-k">def</span> <span class="pl-en">generate_resized_image</span>(<span class="pl-smi">source</span>, <span class="pl-smi">size</span>):
    img_l <span class="pl-k">=</span> Image.open(source)
    img_l.thumbnail(size, Image.<span class="pl-c1">ANTIALIAS</span>)
    data_img <span class="pl-k">=</span> StringIO.StringIO()
    img_l.save(data_img, <span class="pl-s"><span class="pl-pds">'</span>JPEG<span class="pl-pds">'</span></span>)
    img_l.close()
    img_temp_file <span class="pl-k">=</span> InMemoryUploadedFile(data_img, <span class="pl-c1">None</span>,
                                         <span class="pl-c1">str</span>(size[<span class="pl-c1">0</span>]) <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>.jpg<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>image/jpeg<span class="pl-pds">'</span></span>,
                                         data_img.len, <span class="pl-c1">None</span>)
    <span class="pl-k">return</span> img_temp_file


<span class="pl-k">class</span> <span class="pl-en">PictureForm</span>(<span class="pl-e">forms</span>.<span class="pl-e">ModelForm</span>):
    <span class="pl-k">class</span> <span class="pl-en">Meta</span>:
        model <span class="pl-k">=</span> Picture
        fields <span class="pl-k">=</span> [<span class="pl-s"><span class="pl-pds">'</span>title<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>description<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>img_l<span class="pl-pds">'</span></span>]

    <span class="pl-k">def</span> <span class="pl-en">save</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">commit</span><span class="pl-k">=</span><span class="pl-c1">True</span>):
        instance <span class="pl-k">=</span> <span class="pl-c1">super</span>(PictureForm, <span class="pl-v">self</span>).save(<span class="pl-v">commit</span><span class="pl-k">=</span><span class="pl-c1">False</span>)
        source <span class="pl-k">=</span> instance.img_l
        size_img_l <span class="pl-k">=</span> <span class="pl-c1">1920</span>, <span class="pl-c1">1080</span>
        size_img_m <span class="pl-k">=</span> <span class="pl-c1">1366</span>, <span class="pl-c1">768</span>
        size_img_s <span class="pl-k">=</span> <span class="pl-c1">768</span>, <span class="pl-c1">432</span>
        size_img_blur <span class="pl-k">=</span> <span class="pl-c1">9</span>, <span class="pl-c1">9</span>
        instance.save()
        instance.img_blur <span class="pl-k">=</span> image_to_b64(source, size_img_blur)
        img1 <span class="pl-k">=</span> generate_resized_image(source, size_img_l)
        instance.img_l <span class="pl-k">=</span> img1
        instance.img_m <span class="pl-k">=</span> generate_resized_image(source, size_img_m)
        instance.img_s <span class="pl-k">=</span> generate_resized_image(source, size_img_s)
        instance.save()
        <span class="pl-k">return</span> instance
</pre></div>

<p>Results:</p>

<p>--tons of images--
Nice website to test your images:
<a href="http://codebeautify.org/base64-to-image-converter">http://codebeautify.org/base64-to-image-converter</a></p>

<p>also, I chose to save the [9, 9] image as .bmp because it’s smaller than JPG format… Didn’t research why is that, but I think it’s because the JPG has info to decompress his data, and this extra info must be the reason to the extra bytes.</p>

<p>Thanks to <a href="https://br.linkedin.com/in/wagnerbarretto/pt">Wagner Barreto</a> for many tips about the topic.</p>

<p>Usefull links:</p>

<p><a href="https://code.facebook.com/posts/991252547593574/the-technology-behind-preview-photos/">https://code.facebook.com/posts/991252547593574/the-technology-behind-preview-photos/</a></p>

<p><a href="https://dev.opera.com/articles/native-responsive-images/">https://dev.opera.com/articles/native-responsive-images/</a></p>

<p><a href="http://davidbcalhoun.com/2011/when-to-base64-encode-images-and-when-not-to/">http://davidbcalhoun.com/2011/when-to-base64-encode-images-and-when-not-to/</a></p>

<p><a href="https://jmperezperez.com/medium-image-progressive-loading-placeholder/">https://jmperezperez.com/medium-image-progressive-loading-placeholder/</a></p>

<p><a href="https://manu.ninja/dominant-colors-for-lazy-loading-images">https://manu.ninja/dominant-colors-for-lazy-loading-images</a></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/Madalosso/django-thumbnail-blur">Django-thumbnail-blur</a> is maintained by <a href="https://github.com/Madalosso">Madalosso</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
